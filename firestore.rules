rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Użytkownicy: Każdy może czytać, ale tylko właściciel może aktualizować swój profil.
    // Delete zablokowane - tylko admin może usuwać konta.
    match /users/{userId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Kategorie: Każdy może czytać, pisać mogą tylko admini.
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Okazje (Deals): Każdy może czytać. 
    // Użytkownicy mogą tworzyć (status 'draft' wymaga moderacji).
    // Autor może edytować swoje okazje. Admin może moderować wszystkie.
    // Tylko admin może usuwać.
    match /deals/{dealId} {
      allow read: if true;
      allow create: if request.auth != null 
        && request.resource.data.postedBy == request.auth.uid
        && request.resource.data.status == 'draft'
        && request.resource.data.temperature == 0
        && request.resource.data.voteCount == 0
        && request.resource.data.commentsCount == 0;
      allow update: if request.auth != null && (
        resource.data.postedBy == request.auth.uid // Autor może edytować
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' // Admin może moderować
      );
      allow delete: if request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // PRODUKTY: Każdy może czytać. Zapis tylko przez admin (via Cloud Functions/Panel Admin).
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Komentarze: Każdy może czytać. Tworzyć mogą tylko zalogowani. 
    // Edycja/Usuwanie tylko przez autora lub admina (moderacja).
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // Głosy: Każdy może czytać. Zapis tylko dla właściciela głosu.
    match /deals/{dealId}/votes/{userId} {
       allow read: if true;
       allow create, update, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}