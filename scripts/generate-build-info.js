#!/usr/bin/env node
/**
 * Generates src/lib/build-info.ts with commit SHA, build time, and version.
 * Version is based on commit count (e.g., 0.1.123 where 123 = commit count).
 * Runs in prebuild/predev.
 */
const { execSync } = require('child_process');
const { writeFileSync, mkdirSync, readFileSync } = require('fs');
const { join } = require('path');

function safeExec(cmd) {
  try { return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim(); } catch { return null; }
}

const gitSha = process.env.GIT_SHA || safeExec('git rev-parse HEAD') || 'UNKNOWN';
const gitShort = (process.env.GIT_SHA_SHORT || safeExec('git rev-parse --short HEAD') || gitSha.slice(0,7));
const builtAt = new Date().toISOString();

// Get commit count for version numbering
const commitCount = safeExec('git rev-list --count HEAD') || '0';
const baseVersion = '0.1'; // Can be read from package.json if needed
const version = `${baseVersion}.${commitCount}`;

const outDir = join(process.cwd(), 'src', 'lib');
mkdirSync(outDir, { recursive: true });
const outFile = join(outDir, 'build-info.ts');

const content = `// Auto-generated by scripts/generate-build-info.js
export const buildInfo = {
  version: '${version}',
  commit: '${gitSha}',
  commitShort: '${gitShort}',
  builtAt: '${builtAt}',
};
`;

writeFileSync(outFile, content, 'utf8');
console.log('[build-info] Wrote', outFile, { version, commit: gitShort, builtAt });
