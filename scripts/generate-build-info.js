#!/usr/bin/env node
/**
 * Generates src/lib/build-info.ts with commit SHA and build time.
 * Runs in prebuild/predev.
 */
const { execSync } = require('child_process');
const { writeFileSync, mkdirSync } = require('fs');
const { join } = require('path');

function safeExec(cmd) {
  try { return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim(); } catch { return null; }
}

const gitSha = process.env.GIT_SHA || safeExec('git rev-parse HEAD') || 'UNKNOWN';
const gitShort = (process.env.GIT_SHA_SHORT || safeExec('git rev-parse --short HEAD') || gitSha.slice(0,7));
const builtAt = new Date().toISOString();

const outDir = join(process.cwd(), 'src', 'lib');
mkdirSync(outDir, { recursive: true });
const outFile = join(outDir, 'build-info.ts');

const content = `// Auto-generated by scripts/generate-build-info.js
export const buildInfo = {
  commit: '${gitSha}',
  commitShort: '${gitShort}',
  builtAt: '${builtAt}',
};
`;

writeFileSync(outFile, content, 'utf8');
console.log('[build-info] Wrote', outFile, { commit: gitShort, builtAt });
